<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bakery POS + Stock ‚Äî Kasir Mode</title>
  <style>
    :root { font-family: system-ui, Arial; }
    body { margin: 0; background:#f6f7fb; color:#111; }
    header {
      padding: 14px 18px; background:#111; color:#fff;
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      position: sticky; top: 0; z-index: 10;
    }
    header h1 { font-size:16px; margin:0; }
    .tabs { display:flex; gap:8px; }
    .tabs button { width:auto; background:#eef0f7; color:#111; border:1px solid #2b2b2b22; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:800;}
    .tabs button.active { background:#fff; color:#111; border:1px solid #fff; }

    .wrap { display:grid; grid-template-columns: 1.3fr 1fr; gap:14px; padding:14px; }
    .card { background:#fff; border-radius:16px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
    h2 { font-size:14px; margin:0 0 10px; }
    label { font-size:12px; opacity:.85; display:block; margin-bottom:6px; }
    input, select, button, textarea { width:100%; padding:10px; border-radius:12px; border:1px solid #e6e7ee; }
    input:focus, textarea:focus { outline:2px solid #c7d2fe; border-color:#c7d2fe; }
    button { border:none; background:#111; color:#fff; font-weight:900; cursor:pointer; }
    button.secondary { background:#eef0f7; color:#111; border:1px solid #e6e7ee; }
    button.danger { background:#dc2626; }
    .muted { opacity:.7; font-size:12px; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row > * { flex: 1; min-width: 140px; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .actions button { width:auto; padding:10px 12px; border-radius:12px; }
    .pill { font-size:12px; padding:4px 10px; border-radius:999px; background:#eef0f7; display:inline-block; }

    /* POS category + product grid */
    .catbar { display:flex; gap:8px; flex-wrap:wrap; }
    .catbar button { width:auto; padding:10px 12px; border-radius:999px; background:#eef0f7; color:#111; border:1px solid #e6e7ee; font-weight:1000; }
    .catbar button.active { background:#111; color:#fff; border:1px solid #111; }

    .gridProducts {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .productBtn {
      text-align:left; padding:12px; border-radius:16px;
      background:#fff; border:1px solid #e6e7ee; color:#111;
      box-shadow: 0 2px 10px rgba(0,0,0,.03);
      min-height: 74px;
    }
    .productBtn:active { transform: translateY(1px); }
    .productBtn .name { font-weight:1000; font-size:14px; line-height:1.15; }
    .productBtn .meta { margin-top:6px; font-size:12px; opacity:.75; }
    .badgeLow {
      display:inline-block; margin-left:8px; font-size:11px; padding:2px 8px; border-radius:999px;
      background:#fee2e2; color:#991b1b; border:1px solid #fecaca; font-weight:1000;
    }
    .badgeOOS {
      display:inline-block; margin-left:8px; font-size:11px; padding:2px 8px; border-radius:999px;
      background:#e5e7eb; color:#111827; border:1px solid #d1d5db; font-weight:1000;
    }
    .productBtn.disabled { opacity:.55; background:#f9fafb; cursor:not-allowed; }

    /* Cart */
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:10px; border-bottom:1px solid #eee; vertical-align:top; }
    th { text-align:left; font-size:12px; opacity:.8; }
    .right { text-align:right; }
    .qtyCtl { display:flex; gap:6px; justify-content:flex-end; }
    .qtyCtl button { padding:6px 10px; border-radius:10px; }
    .qtyCtl span { min-width:34px; text-align:center; display:inline-block; padding-top:6px; font-weight:1000; }

    .totalBox {
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;
      padding:12px; border-radius:16px; background:#f3f4f6;
    }
    .totalBox .big { font-size:20px; font-weight:1000; }

    /* Quick qty & quick pay */
    .quickRow { display:flex; gap:8px; flex-wrap:wrap; }
    .quickRow button { width:auto; padding:10px 12px; border-radius:999px; background:#eef0f7; color:#111; border:1px solid #e6e7ee; font-weight:1000; }
    .quickRow button.primary { background:#111; color:#fff; border:1px solid #111; }

    @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; } .gridProducts{ grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 640px) { .gridProducts{ grid-template-columns: repeat(2, 1fr);} }
  </style>
</head>
<body>
<header>
  <h1>üçû Bakery POS + Stock ‚Äî Kasir Mode</h1>
  <div class="tabs">
    <button id="tabPos" class="active">POS</button>
    <button id="tabProduk">Produk</button>
    <button id="tabLaporan">Laporan</button>
  </div>
</header>

<div class="wrap">
  <!-- LEFT -->
  <section class="card">
    <!-- POS -->
    <div id="posView">
      <h2>Kasir</h2>

      <div class="row">
        <div style="flex:2;min-width:240px">
          <label>Cari Produk</label>
          <input id="searchInput" placeholder="Ketik nama produk‚Ä¶ (contoh: coklat, tawar, selai)" />
          <div class="muted" id="searchHint" style="margin-top:6px"></div>
        </div>
        <div>
          <label>Tambah Qty Cepat (klik produk)</label>
          <div class="quickRow">
            <button class="primary" data-qadd="1">+1</button>
            <button data-qadd="2">+2</button>
            <button data-qadd="5">+5</button>
          </div>
          <div class="muted" style="margin-top:6px">Default: +1</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Kategori</label>
        <div id="catBar" class="catbar"></div>
      </div>

      <div style="margin-top:12px">
        <label>Produk (klik untuk tambah ke keranjang)</label>
        <div id="productGrid" class="gridProducts"></div>
        <div class="muted" id="gridHint" style="margin-top:8px"></div>
      </div>

      <hr style="border:none;border-top:1px solid #eee;margin:14px 0" />

      <h2>Keranjang</h2>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th class="right">Qty</th>
            <th class="right">Subtotal</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>

      <div class="totalBox" style="margin-top:10px">
        <div>
          <div class="muted">Total</div>
          <div class="mono big" id="cartTotal">Rp0</div>
          <div class="muted" id="changeHint" style="margin-top:6px"></div>
        </div>
        <div style="min-width:260px">
          <label>Bayar (Rp)</label>
          <input id="payAmount" type="number" min="0" placeholder="0" />
          
          <label style="margin-top:10px">Metode Bayar</label>
          <div class="quickRow" id="payMethodRow">
            <button class="primary" data-method="CASH">CASH</button>
            <button data-method="QRIS">QRIS</button>
            <button data-method="DEBET">DEBET</button>
          </div>
          <div class="muted" id="payMethodHint" style="margin-top:6px"></div>
<div class="quickRow" style="margin-top:10px">
            <button data-pay="20000">20k</button>
            <button data-pay="50000">50k</button>
            <button data-pay="100000">100k</button>
            <button class="secondary" id="btnPayExact" style="border-radius:999px;font-weight:1000">Uang Pas</button>
          </div>
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="btnCheckout">Selesaikan Transaksi</button>
        <button id="btnClearCart" class="secondary">Reset Keranjang</button>
        <button id="btnExport" class="secondary">Export Data (JSON)</button>
      </div>
      <div class="muted" id="checkoutMsg" style="margin-top:8px"></div>
    </div>

    <!-- PRODUK -->
    <div id="produkView" style="display:none">
      <h2>Master Produk</h2>

      <div class="row">
        <div>
          <label>Kategori</label>
          <select id="pCategorySelect"></select>
          <div class="muted" style="margin-top:6px">Kategori fixed: Roti Isi, Tawar, Selai, Roti Mentega.</div>
        </div>
        <div>
          <label>Nama Produk</label>
          <input id="pName" placeholder="Contoh: Roti Coklat" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Harga (Rp)</label>
          <input id="pPrice" type="number" min="0" placeholder="18000" />
        </div>
        <div>
          <label>Stok Awal</label>
          <input id="pStock" type="number" min="0" placeholder="20" />
        </div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="btnAddProduct">Tambah Produk</button>
        <button id="btnSeed" class="secondary">Isi Contoh Produk</button>
      </div>

      <div style="margin-top:14px">
        <h2>Tambah Banyak Produk (Paste dari Excel)</h2>
        <div class="muted">Format: <span class="mono">Kategori | Nama | Harga | Stok</span> (1 baris = 1 produk)</div>
        <textarea id="bulkInput" rows="6" placeholder="Roti Isi | Roti Coklat | 18000 | 20&#10;Tawar | Tawar Original | 20000 | 10" style="margin-top:8px"></textarea>
        <div class="actions" style="margin-top:10px">
          <button id="btnBulkAdd">Import dari Paste</button>
          <button id="btnBulkClear" class="secondary">Clear</button>
        </div>
      </div>

      
      <div style="margin-top:14px">
        <h2>RETUR ke Supplier</h2>
        <div class="muted">Gunakan saat stok berlebih dan mau dibalikin ke pengirim. Stok akan berkurang sesuai qty retur.</div>

        <div class="row" style="margin-top:10px">
          <div style="flex:2;min-width:220px">
            <label>Pilih Produk</label>
            <select id="retProduct"></select>
          </div>
          <div>
            <label>Qty Retur</label>
            <input id="retQty" type="number" min="1" placeholder="1" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:2;min-width:220px">
            <label>Catatan (opsional)</label>
            <input id="retNote" placeholder="Contoh: retur ke supplier A / alasan" />
          </div>
          <div style="display:flex;align-items:flex-end">
            <button id="btnRetur" class="danger" style="width:100%">Proses Retur</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <h2>Riwayat Retur</h2>
          <table>
            <thead>
              <tr>
                <th>Waktu</th>
                <th>Produk</th>
                <th class="right">Qty</th>
                <th>Catatan</th>
              </tr>
            </thead>
            <tbody id="retBody"></tbody>
          </table>
        </div>
      </div>

<div style="margin-top:14px">
        <h2>Daftar Produk</h2>
        <table>
          <thead>
            <tr>
              <th>Nama</th>
              <th>Kategori</th>
              <th class="right">Harga</th>
              <th class="right">Stok</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="productBody"></tbody>
        </table>
        <div class="muted">LOW stock = ‚â§ 5</div>
      </div>
    </div>

    <!-- LAPORAN -->
    <div id="laporanView" style="display:none">
      <h2>Laporan</h2>
      <div class="row">
        <div class="card" style="box-shadow:none;border:1px solid #eee">
          <div class="muted">Penjualan Hari Ini</div>
          <div class="mono" id="salesToday">Rp0</div>
        </div>
        <div class="card" style="box-shadow:none;border:1px solid #eee">
          <div class="muted">Jumlah Transaksi Hari Ini</div>
          <div class="mono" id="txToday">0</div>
        </div>
      </div>

      <div style="margin-top:14px">
        <h2>Riwayat Transaksi</h2>

        <div class="actions" style="margin:10px 0 12px">
          <button id="btnExportSalesCSV" class="secondary">Export Laporan Penjualan (Excel .CSV)</button>
          <button id="btnExportReturCSV" class="secondary">Export Laporan Retur (Excel .CSV)</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Waktu</th>
              <th>Items</th>
              <th>Metode</th>
              <th class="right">Total</th>
            </tr>
          </thead>
          <tbody id="txBody"></tbody>
        </table>
        <div class="muted" style="margin-top:10px">
          Export CSV = bisa dibuka langsung di Excel. Kalau mau jadi .xlsx: buka CSV di Excel ‚Üí Save As ‚Üí .xlsx
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT -->
  <aside class="card">
    <h2>Status</h2>
    <div class="pill">Offline ‚Ä¢ Data tersimpan di device (LocalStorage)</div>
    <div class="muted" style="margin-top:10px">
      Kalau mau multi-device, nanti kita pindah ke database online + login.
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:14px 0" />

    <h2>Quick Actions</h2>
    <div class="actions">
      <button id="btnResetAll" class="danger">Hapus Semua Data</button>
      <button id="btnImport" class="secondary">Import Data (JSON)</button>
    </div>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </aside>
</div>

<script>
  // ===== CONFIG (sesuai kamu) =====
  const CATEGORY_ORDER = ["Roti Isi", "Tawar", "Selai", "Roti Mentega"];
  const LOW_STOCK_THRESHOLD = 5;

  // ===== Storage =====
  const KEY = "bakery_pos_kasir_v2_csv";
  const fmt = (n) => "Rp" + (Number(n||0)).toLocaleString("id-ID");
  const todayKey = () => new Date().toISOString().slice(0,10);

  function loadState() {
    const raw = localStorage.getItem(KEY);
    if (raw) return JSON.parse(raw);
    return { products: [], transactions: [], cart: [], returns: [], settings: { payMethod: "CASH" } };
  }
  function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  let state = loadState();

  
  // ===== Migration / defaults (biar aman kalau storage lama) =====
  if (!state || typeof state !== "object") state = { products: [], transactions: [], cart: [], returns: [], settings: { payMethod: "CASH" } };
  state.products = Array.isArray(state.products) ? state.products : [];
  state.transactions = Array.isArray(state.transactions) ? state.transactions : [];
  state.cart = Array.isArray(state.cart) ? state.cart : [];
  state.returns = Array.isArray(state.returns) ? state.returns : [];
  state.settings = (state.settings && typeof state.settings === "object") ? state.settings : {};
  state.settings.payMethod = state.settings.payMethod || "CASH";

// ===== DOM =====
  const tabPos = document.getElementById("tabPos");
  const tabProduk = document.getElementById("tabProduk");
  const tabLaporan = document.getElementById("tabLaporan");

  const posView = document.getElementById("posView");
  const produkView = document.getElementById("produkView");
  const laporanView = document.getElementById("laporanView");

  const catBar = document.getElementById("catBar");
  const productGrid = document.getElementById("productGrid");
  const gridHint = document.getElementById("gridHint");

  const searchInput = document.getElementById("searchInput");
  const searchHint = document.getElementById("searchHint");

  const cartBody = document.getElementById("cartBody");
  const cartTotal = document.getElementById("cartTotal");
  const payAmount = document.getElementById("payAmount");
  const payMethodRow = document.getElementById("payMethodRow");
  const payMethodHint = document.getElementById("payMethodHint");

  const changeHint = document.getElementById("changeHint");
  const checkoutMsg = document.getElementById("checkoutMsg");

  const pCategorySelect = document.getElementById("pCategorySelect");
  const pName = document.getElementById("pName");
  const pPrice = document.getElementById("pPrice");
  const pStock = document.getElementById("pStock");
  const bulkInput = document.getElementById("bulkInput");
  const productBody = document.getElementById("productBody");

  const retProduct = document.getElementById("retProduct");
  const retQty = document.getElementById("retQty");
  const retNote = document.getElementById("retNote");
  const retBody = document.getElementById("retBody");

  const salesToday = document.getElementById("salesToday");
  const txToday = document.getElementById("txToday");
  const txBody = document.getElementById("txBody");

  // ===== Tabs =====
  function setTab(which){
    tabPos.classList.toggle("active", which==="pos");
    tabProduk.classList.toggle("active", which==="produk");
    tabLaporan.classList.toggle("active", which==="laporan");
    posView.style.display = which==="pos" ? "" : "none";
    produkView.style.display = which==="produk" ? "" : "none";
    laporanView.style.display = which==="laporan" ? "" : "none";
    renderAll();
  }
  tabPos.onclick = () => setTab("pos");
  tabProduk.onclick = () => setTab("produk");
  tabLaporan.onclick = () => setTab("laporan");

  // ===== Helpers =====
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function normCat(c){
    const t = (c||"").trim();
    if (!t) return "Roti Isi";
    const map = {
      "roti isi":"Roti Isi",
      "tawar":"Tawar",
      "selai":"Selai",
      "roti mentega":"Roti Mentega"
    };
    const key = t.toLowerCase();
    return map[key] || t;
  }
  function getProduct(id){ return state.products.find(p => p.id===id); }

  // ===== POS Controls =====
  let activeCategory = "Semua";
  let quickAddQty = 1;

  // ===== Payment Method (CASH / QRIS / DEBET) =====
  const PAYMENT_METHODS = ["CASH", "QRIS", "DEBET"];
  let payMethod = (state.settings && state.settings.payMethod) ? state.settings.payMethod : "CASH";

  function setPayMethod(m){
    if (!PAYMENT_METHODS.includes(m)) m = "CASH";
    payMethod = m;
    state.settings = state.settings || {};
    state.settings.payMethod = m;
    saveState();

    // Update UI
    if (payMethodRow){
      payMethodRow.querySelectorAll("button[data-method]").forEach(btn=>{
        btn.classList.toggle("primary", btn.dataset.method === m);
      });
    }

    // Behavior:
    // - CASH: input bayar bisa diisi manual + quick pay aktif
    // - QRIS/DEBET: bayar = total otomatis (kembalian 0)
    const isCash = (m === "CASH");
    payAmount.disabled = !isCash;

    document.querySelectorAll("button[data-pay]").forEach(b=> b.disabled = !isCash);
    const btnExact = document.getElementById("btnPayExact");
    if (btnExact) btnExact.disabled = !isCash;

    if (!isCash){
      payAmount.value = cartSum();
      changeHint.textContent = "";
      if (payMethodHint) payMethodHint.textContent = "Non-cash: bayar otomatis = total (kembalian 0).";
    } else {
      if (payMethodHint) payMethodHint.textContent = "";
      updateChangeHint();
    }
  }

  if (payMethodRow){
    payMethodRow.querySelectorAll("button[data-method]").forEach(btn=>{
      btn.onclick = () => setPayMethod(btn.dataset.method);
    });
  }
document.querySelectorAll('button[data-qadd]').forEach(b=>{
    b.onclick = () => {
      quickAddQty = Number(b.dataset.qadd || 1);
      document.querySelectorAll('button[data-qadd]').forEach(x=>{
        x.classList.toggle("primary", x === b);
      });
      renderPOSGrid();
    };
  });

  searchInput.oninput = () => renderPOSGrid();

  function categoriesForPOS(){
    return ["Semua", ...CATEGORY_ORDER];
  }

  function renderCategoryBar(){
    catBar.innerHTML = "";
    const cats = categoriesForPOS();
    if (!cats.includes(activeCategory)) activeCategory = "Semua";

    cats.forEach(cat=>{
      const btn = document.createElement("button");
      btn.textContent = cat;
      btn.className = (cat === activeCategory) ? "active" : "";
      btn.onclick = () => { activeCategory = cat; renderPOSGrid(); };
      catBar.appendChild(btn);
    });
  }

  function renderPOSGrid(){
    productGrid.innerHTML = "";
    const q = (searchInput.value || "").trim().toLowerCase();

    const base = state.products.filter(p => p.is_active !== false);
    let list = base;

    if (activeCategory !== "Semua") {
      list = list.filter(p => normCat(p.category) === activeCategory);
    } else {
      list = list.filter(p => CATEGORY_ORDER.includes(normCat(p.category)));
    }

    if (q) {
      list = list.filter(p => (p.name || "").toLowerCase().includes(q));
      searchHint.textContent = `Hasil pencarian: "${q}"`;
    } else {
      searchHint.textContent = "";
    }

    list.sort((a,b)=>{
      const ca = CATEGORY_ORDER.indexOf(normCat(a.category));
      const cb = CATEGORY_ORDER.indexOf(normCat(b.category));
      if (ca !== cb) return ca - cb;
      return (a.name||"").localeCompare(b.name||"");
    });

    if (state.products.length === 0){
      gridHint.textContent = "Belum ada produk. Tambah dulu di tab Produk.";
      return;
    }
    if (list.length === 0){
      gridHint.textContent = "Tidak ada produk untuk filter ini.";
      return;
    }
    gridHint.textContent = `Klik produk untuk tambah qty +${quickAddQty}.`;

    list.forEach(p=>{
      const btn = document.createElement("button");
      btn.className = "productBtn";

      const isLow = p.stock <= LOW_STOCK_THRESHOLD && p.stock > 0;
      const isOOS = p.stock <= 0;

      const badge = isOOS
        ? `<span class="badgeOOS">HABIS</span>`
        : (isLow ? `<span class="badgeLow">LOW</span>` : "");

      btn.innerHTML = `
        <div class="name">${p.name}${badge}</div>
        <div class="meta">${fmt(p.price)} ‚Ä¢ stok: ${p.stock}</div>
      `;

      if (isOOS) btn.classList.add("disabled");

      btn.onclick = () => {
        if (isOOS) return;
        addToCartByProduct(p.id, quickAddQty);
      };

      productGrid.appendChild(btn);
    });
  }

  function addToCartByProduct(pid, qty){
    checkoutMsg.textContent = "";
    const p = getProduct(pid);
    qty = Math.max(1, Number(qty||1));
    if (!p){ checkoutMsg.textContent = "Produk tidak ditemukan."; return; }
    if (p.stock <= 0){ checkoutMsg.textContent = `${p.name} stok habis.`; return; }

    const existing = state.cart.find(x=>x.productId===pid);
    const currentQty = existing ? existing.qty : 0;
    if (currentQty + qty > p.stock){
      checkoutMsg.textContent = `Qty ${p.name} melebihi stok. Stok: ${p.stock}`;
      return;
    }

    if (existing) existing.qty += qty;
    else state.cart.push({ id: uid(), productId: pid, name: p.name, price: p.price, qty });

    saveState();
    renderCart();
    renderPOSGrid();
    setPayMethod(payMethod);
  }

  // ===== Cart =====
  function cartSum(){ return state.cart.reduce((acc,it)=> acc + it.qty * it.price, 0); }

  function renderCart(){
    cartBody.innerHTML = "";
    if (state.cart.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="muted">Keranjang kosong.</td>`;
      cartBody.appendChild(tr);
      cartTotal.textContent = fmt(0);
      return;
    }

    state.cart.forEach(item=>{
      const sub = item.qty * item.price;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="font-weight:1000">${item.name}</div>
          <div class="muted mono">${fmt(item.price)} / pcs</div>
        </td>
        <td class="right">
          <div class="qtyCtl">
            <button class="secondary" data-dec="${item.id}">-</button>
            <span class="mono">${item.qty}</span>
            <button class="secondary" data-inc="${item.id}">+</button>
          </div>
        </td>
        <td class="right mono">${fmt(sub)}</td>
        <td class="right">
          <button class="danger" style="width:auto;padding:8px 10px;border-radius:12px" data-del="${item.id}">X</button>
        </td>
      `;
      cartBody.appendChild(tr);
    });

    cartBody.querySelectorAll("button[data-inc]").forEach(btn=>{
      btn.onclick = () => {
        const id = btn.dataset.inc;
        const it = state.cart.find(x=>x.id===id);
        if (!it) return;
        const p = getProduct(it.productId);
        if (p && it.qty + 1 > p.stock) return;
        it.qty += 1;
        saveState(); renderCart(); renderPOSGrid(); setPayMethod(payMethod);
  };
    });

    cartBody.querySelectorAll("button[data-dec]").forEach(btn=>{
      btn.onclick = () => {
        const id = btn.dataset.dec;
        const it = state.cart.find(x=>x.id===id);
        if (!it) return;
        it.qty -= 1;
        if (it.qty <= 0) state.cart = state.cart.filter(x=>x.id!==id);
        saveState(); renderCart(); renderPOSGrid(); setPayMethod(payMethod);
      };
    });

    cartBody.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.onclick = () => {
        const id = btn.dataset.del;
        state.cart = state.cart.filter(x=>x.id!==id);
        saveState(); renderCart(); renderPOSGrid(); setPayMethod(payMethod);
      };
    });

    cartTotal.textContent = fmt(cartSum());
  }

  function updateChangeHint(){
    const total = cartSum();
    const isCash = (payMethod === "CASH");

    if (!isCash){
      changeHint.textContent = total ? "Non-cash: kembalian Rp0" : "";
      return;
    }

    const pay = Number(payAmount.value || 0);
    if (!total || !pay) { changeHint.textContent = ""; return; }
    const diff = pay - total;
    changeHint.textContent = diff < 0 ? `Kurang: ${fmt(Math.abs(diff))}` : `Kembalian: ${fmt(diff)}`;
  }
  payAmount.oninput = updateChangeHint;

  document.querySelectorAll("button[data-pay]").forEach(b=>{
    b.onclick = () => { payAmount.value = Number(b.dataset.pay || 0); updateChangeHint(); };
  });
  document.getElementById("btnPayExact").onclick = () => { payAmount.value = cartSum(); updateChangeHint(); };

  document.getElementById("btnClearCart").onclick = () => {
    state.cart = [];
    payAmount.value = "";
    checkoutMsg.textContent = "";
    saveState(); renderCart(); renderPOSGrid(); setPayMethod(payMethod);
      };

  document.getElementById("btnCheckout").onclick = () => {
    checkoutMsg.textContent = "";
    if (state.cart.length===0){ checkoutMsg.textContent = "Keranjang masih kosong."; return; }

    const total = cartSum();
    const isCash = (payMethod === "CASH");

    let pay = Number(payAmount.value || 0);
    if (!isCash){
      // QRIS / DEBET
      pay = total;
      payAmount.value = total;
    }

    if (isCash && pay < total){
      checkoutMsg.textContent = `Uang bayar kurang. Total ${fmt(total)}.`;
      return;
    }

    for (const it of state.cart){
      const p = getProduct(it.productId);
      if (!p || p.stock < it.qty){
        checkoutMsg.textContent = `Stok tidak cukup untuk ${it.name}.`;
        return;
      }
    }

    for (const it of state.cart){
      const p = getProduct(it.productId);
      p.stock -= it.qty;
    }

    const change = isCash ? (pay - total) : 0;
    const tx = {
      id: uid(),
      createdAt: Date.now(),
      dateKey: todayKey(),
      paymentMethod: payMethod,
      items: state.cart.map(x=>({ name:x.name, qty:x.qty, price:x.price })),
      total, paid: pay, change
    };
    state.transactions.push(tx);

    state.cart = [];
    payAmount.value = "";
    saveState();
    renderAll();

    checkoutMsg.textContent = `Transaksi sukses ‚úÖ Metode: ${payMethod}${isCash ? ` ‚Ä¢ Kembalian: ${fmt(change)}` : ""}`;
  };

  // ===== Produk =====
  function renderCategorySelect(){
    pCategorySelect.innerHTML = "";
    CATEGORY_ORDER.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      pCategorySelect.appendChild(opt);
    });
  }

  document.getElementById("btnAddProduct").onclick = () => {
    const category = pCategorySelect.value;
    const name = (pName.value||"").trim();
    const price = Number(pPrice.value||0);
    const stock = Number(pStock.value||0);

    if (!name){ alert("Nama produk wajib diisi"); return; }
    if (!isFinite(price) || price < 0){ alert("Harga tidak valid"); return; }
    if (!isFinite(stock) || stock < 0){ alert("Stok tidak valid"); return; }

    state.products.push({ id: uid(), name, price, stock, category, is_active: true });
    pName.value=""; pPrice.value=""; pStock.value="";
    saveState(); renderAll();
  };

  document.getElementById("btnBulkAdd").onclick = () => {
    const text = (bulkInput.value || "").trim();
    if (!text) { alert("Paste daftar produk dulu ya."); return; }

    const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
    let added = 0, skipped = 0;

    for (const line of lines) {
      const parts = line.split("|").map(p => p.trim());
      if (parts.length < 4) { skipped++; continue; }

      const [catRaw, name, priceStr, stockStr] = parts;
      const category = normCat(catRaw);
      const price = Number(priceStr);
      const stock = Number(stockStr);

      if (!CATEGORY_ORDER.includes(category)) { skipped++; continue; }
      if (!name || !isFinite(price) || !isFinite(stock)) { skipped++; continue; }

      state.products.push({ id: uid(), name, price, stock, category, is_active: true });
      added++;
    }

    saveState(); renderAll();
    alert(`Berhasil tambah ${added} produk. (skip: ${skipped})`);
  };

  document.getElementById("btnBulkClear").onclick = () => { bulkInput.value = ""; };

  document.getElementById("btnSeed").onclick = () => {
    if (!confirm("Isi contoh produk? (tidak menghapus data lama)")) return;
    state.products.push(
      { id: uid(), name:"Roti Coklat", price:18000, stock:12, category:"Roti Isi", is_active:true },
      { id: uid(), name:"Roti Keju", price:19000, stock:5, category:"Roti Isi", is_active:true },
      { id: uid(), name:"Tawar Original", price:20000, stock:8, category:"Tawar", is_active:true },
      { id: uid(), name:"Tawar Gandum", price:24000, stock:4, category:"Tawar", is_active:true },
      { id: uid(), name:"Selai Strawberry", price:28000, stock:6, category:"Selai", is_active:true },
      { id: uid(), name:"Roti Mentega Classic", price:16000, stock:3, category:"Roti Mentega", is_active:true }
    );
    saveState(); renderAll();
  };

  function renderProductsTable(){
    productBody.innerHTML = "";

    const list = state.products.slice().sort((a,b)=>{
      const ca = CATEGORY_ORDER.indexOf(normCat(a.category));
      const cb = CATEGORY_ORDER.indexOf(normCat(b.category));
      if (ca !== cb) return ca - cb;
      return (a.name||"").localeCompare(b.name||"");
    });

    if (list.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="muted">Belum ada produk.</td>`;
      productBody.appendChild(tr);
      return;
    }

    list.forEach(p=>{
      const status = (p.stock <= 0) ? "HABIS" : (p.stock <= LOW_STOCK_THRESHOLD ? "LOW" : "");
      const badge = status ? `<span class="pill" style="margin-left:8px">${status}</span>` : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><strong>${p.name}</strong>${badge}</td>
        <td>${normCat(p.category)}</td>
        <td class="right mono">${fmt(p.price)}</td>
        <td class="right mono">${p.stock}</td>
        <td class="right">
          <div class="actions" style="justify-content:flex-end">
            <button class="secondary" data-act="addstock" data-id="${p.id}">+Stok</button>
            <button class="secondary" data-act="edit" data-id="${p.id}">Edit</button>
            <button class="danger" data-act="del" data-id="${p.id}">Hapus</button>
          </div>
        </td>
      `;
      productBody.appendChild(tr);
    });

    productBody.querySelectorAll("button").forEach(btn=>{
      btn.onclick = () => {
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        const p = getProduct(id);
        if (!p) return;

        if (act==="del"){
          if (!confirm("Hapus produk ini?")) return;
          state.products = state.products.filter(x=>x.id!==id);
          state.cart = state.cart.filter(c=>c.productId!==id);
          saveState(); renderAll();
        }

        if (act==="addstock"){
          const add = Number(prompt("Tambah stok berapa?","10")||0);
          if (add<=0) return;
          p.stock += add;
          saveState(); renderAll();
        }

        if (act==="edit"){
          const name = prompt("Nama produk:", p.name) ?? p.name;
          const price = Number(prompt("Harga (Rp):", p.price) ?? p.price);
          const stock = Number(prompt("Stok:", p.stock) ?? p.stock);
          const cat = prompt("Kategori (Roti Isi/Tawar/Selai/Roti Mentega):", normCat(p.category)) ?? normCat(p.category);
          const catN = normCat(cat);
          if (!CATEGORY_ORDER.includes(catN)) { alert("Kategori tidak valid."); return; }

          p.name = (name.trim() || p.name);
          p.price = isFinite(price) ? price : p.price;
          p.stock = isFinite(stock) ? stock : p.stock;
          p.category = catN;

          saveState(); renderAll();
        }
      };
    });
  }

  // ===== RETUR =====
  function renderReturUI(){
    if (!retProduct) return;

    // dropdown produk
    retProduct.innerHTML = "";
    const active = state.products.filter(p => p.is_active !== false);
    if (active.length === 0){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Belum ada produk";
      retProduct.appendChild(opt);
      return;
    }

    active.slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"")).forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = `${p.name} (stok: ${p.stock})`;
      retProduct.appendChild(opt);
    });
  }

  function renderReturTable(){
    if (!retBody) return;
    retBody.innerHTML = "";

    if (!state.returns || state.returns.length === 0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="muted">Belum ada retur.</td>`;
      retBody.appendChild(tr);
      return;
    }

    state.returns.slice().reverse().forEach(r=>{
      const tr = document.createElement("tr");
      const time = new Date(r.createdAt).toLocaleString("id-ID");
      tr.innerHTML = `
        <td class="mono">${time}</td>
        <td><strong>${r.productName || "-"}</strong></td>
        <td class="right mono">${r.qty || 0}</td>
        <td>${r.note ? String(r.note) : ""}</td>
      `;
      retBody.appendChild(tr);
    });
  }

  const btnRetur = document.getElementById("btnRetur");
  if (btnRetur){
    btnRetur.onclick = () => {
      const pid = (retProduct && retProduct.value) ? retProduct.value : "";
      const qty = Math.max(1, Number(retQty && retQty.value ? retQty.value : 0));
      const note = (retNote && retNote.value) ? retNote.value.trim() : "";

      if (!pid){ alert("Pilih produk dulu."); return; }
      const p = getProduct(pid);
      if (!p){ alert("Produk tidak ditemukan."); return; }
      if (!isFinite(qty) || qty <= 0){ alert("Qty retur tidak valid."); return; }
      if (qty > (Number(p.stock)||0)){ alert(`Qty retur melebihi stok. Stok ${p.stock}`); return; }

      if (!confirm(`Retur ${p.name} sebanyak ${qty}? Stok akan berkurang.`)) return;

      p.stock -= qty;
      state.returns.push({
        id: uid(),
        createdAt: Date.now(),
        productId: pid,
        productName: p.name,
        qty,
        note
      });

      if (retQty) retQty.value = "";
      if (retNote) retNote.value = "";

      saveState();
      renderAll();
      alert("Retur tersimpan ‚úÖ");
    };
  }


  // ===== Reports =====
  function renderReports(){
    const tKey = todayKey();
    const todayTx = state.transactions.filter(tx => tx.dateKey === tKey);
    const total = todayTx.reduce((acc,tx)=>acc+tx.total,0);
    salesToday.textContent = fmt(total);
    txToday.textContent = todayTx.length;

    txBody.innerHTML = "";
    if (state.transactions.length===0){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="4" class="muted">Belum ada transaksi.</td>`;
      txBody.appendChild(tr);
      return;
    }

    state.transactions.slice().reverse().forEach(tx=>{
      const tr = document.createElement("tr");
      const time = new Date(tx.createdAt).toLocaleString("id-ID");
      const items = (tx.items||[]).map(i=>`${i.name}√ó${i.qty}`).join(", ");
      const method = tx.paymentMethod || "CASH";
      tr.innerHTML = `
        <td class="mono">${time}</td>
        <td>${items}</td>
        <td><span class="pill">${method}</span></td>
        <td class="right mono">${fmt(tx.total)}</td>
      `;
      txBody.appendChild(tr);
    });
  }

  // ===== Export / Import Data (JSON) =====
  document.getElementById("btnExport").onclick = () => {
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "bakery-pos-data.json";
    a.click();
    URL.revokeObjectURL(url);
  };

  const importFile = document.getElementById("importFile");
  document.getElementById("btnImport").onclick = () => importFile.click();
  importFile.onchange = async () => {
    const file = importFile.files[0];
    if (!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if (!data.products || !data.transactions || !data.cart) throw new Error("Format JSON tidak sesuai");
      state = data;
      // migration for older export files
      state.returns = Array.isArray(state.returns) ? state.returns : [];
      state.settings = (state.settings && typeof state.settings === "object") ? state.settings : (state.settings || {});
      state.settings.payMethod = state.settings.payMethod || "CASH";
      saveState(); renderAll();
      alert("Import sukses!");
    }catch(e){
      alert("Import gagal: " + e.message);
    }finally{
      importFile.value = "";
    }
  };

  document.getElementById("btnResetAll").onclick = () => {
    if (!confirm("Yakin hapus semua data?")) return;
    localStorage.removeItem(KEY);
    state = loadState();
    saveState(); renderAll();
  };

  // ===== Export Laporan Penjualan ke Excel (CSV) =====
  function csvEscape(v){
    const s = String(v ?? "");
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function downloadCSV(filename, rows){
    const csv = rows.map(r => r.map(csvEscape).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  document.getElementById("btnExportSalesCSV").onclick = () => {
    if (!state.transactions || state.transactions.length === 0){
      alert("Belum ada transaksi untuk diexport.");
      return;
    }

    const rows = [];
    rows.push([
      "transaction_id",
      "datetime",
      "date",
      "total",
      "paid",
      "change",
      "payment_method",
      "item_name",
      "item_qty",
      "item_price",
      "item_subtotal"
    ]);

    state.transactions.forEach(tx => {
      const dt = new Date(tx.createdAt);
      const datetime = dt.toLocaleString("id-ID");
      const date = dt.toISOString().slice(0,10);

      (tx.items || []).forEach(it => {
        const qty = Number(it.qty || 0);
        const price = Number(it.price || 0);
        rows.push([
          tx.id,
          datetime,
          date,
          tx.total ?? 0,
          tx.paid ?? 0,
          tx.change ?? 0,
          (tx.paymentMethod || "CASH"),
          it.name ?? "",
          qty,
          price,
          qty * price
        ]);
      });
    });

    const filename = `laporan-penjualan-${todayKey()}.csv`;
    downloadCSV(filename, rows);
  };

  // ===== Export Laporan Retur ke Excel (CSV) =====
  document.getElementById("btnExportReturCSV").onclick = () => {
    if (!state.returns || state.returns.length === 0){
      alert("Belum ada data retur untuk diexport.");
      return;
    }

    const rows = [];
    rows.push([
      "retur_id",
      "datetime",
      "date",
      "product_name",
      "qty_retur",
      "note"
    ]);

    state.returns.forEach(r => {
      const dt = new Date(r.createdAt);
      rows.push([
        r.id,
        dt.toLocaleString("id-ID"),
        dt.toISOString().slice(0,10),
        r.productName ?? "",
        r.qty ?? 0,
        r.note ?? ""
      ]);
    });

    const filename = `laporan-retur-${todayKey()}.csv`;
    downloadCSV(filename, rows);
  };


  // ===== Render All =====
  function renderAll(){
    renderCategorySelect();
    renderCategoryBar();
    renderPOSGrid();
    renderCart();
    renderProductsTable();
    renderReturUI();
    renderReturTable();
    renderReports();
    setPayMethod(payMethod);
  }

  // init
  saveState();
  renderAll();
</script>
</body>
</html>
